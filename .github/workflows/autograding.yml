name: Autograding Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate Variant Config
        run: |
          python - <<'PY'
          import importlib.util
          import json
          import os

          spec = importlib.util.spec_from_file_location("get_variant", "scripts/get_variant.py")
          module = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(module)

          variant = module.get_my_variant()
          with open(".variant_config.json", "w", encoding="utf-8") as f:
              json.dump(variant, f, indent=2)

          print(
              "Generated variant for {student} (group {group}) in {repo}".format(
                  student=variant.get("student_id", "unknown"),
                  group=variant.get("group_id"),
                  repo=os.environ.get("GITHUB_REPOSITORY", "local"),
              )
          )
          PY

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report pandas matplotlib numpy scipy
          pip install -e . 2>/dev/null || true

      - name: Run visible tests
        id: visible-tests
        run: |
          pytest tests/visible/ -v --tb=short \
            --json-report --json-report-file=visible_results.json \
            2>&1 | tee visible_output.txt
          echo "visible_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Run hidden tests
        id: hidden-tests
        if: always()
        run: |
          pytest tests/hidden/ -v --tb=short \
            --json-report --json-report-file=hidden_results.json \
            2>&1 | tee hidden_output.txt
          echo "hidden_exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Calculate grade and write summary
        if: always()
        run: |
          python - <<'PYEOF'
          import json
          import os

          def load_results(path):
              try:
                  with open(path) as f:
                      data = json.load(f)
                  summary = data.get("summary", {})
                  passed = summary.get("passed", 0)
                  total = summary.get("total", 0)
                  failed = summary.get("failed", 0)
                  errors = summary.get("error", 0)
                  return passed, total, failed, errors
              except Exception:
                  return 0, 0, 0, 0

          vis_passed, vis_total, vis_failed, vis_errors = load_results("visible_results.json")
          hid_passed, hid_total, hid_failed, hid_errors = load_results("hidden_results.json")

          # Visible: 40 points, Hidden: 30 points
          vis_score = round((vis_passed / vis_total) * 40) if vis_total > 0 else 0
          hid_score = round((hid_passed / hid_total) * 30) if hid_total > 0 else 0
          total_score = vis_score + hid_score

          summary_path = os.environ.get("GITHUB_STEP_SUMMARY", "")

          lines = []
          lines.append("## Mini-Project: Field Sample Pipeline - Test Results")
          lines.append("")
          lines.append("### Visible Tests (40%)")
          lines.append(f"- Passed: **{vis_passed}/{vis_total}**")
          lines.append(f"- Score: **{vis_score}/40**")
          lines.append("")
          lines.append("### Hidden Tests (30%)")
          lines.append(f"- Passed: **{hid_passed}/{hid_total}**")
          lines.append(f"- Score: **{hid_score}/30**")
          lines.append("")
          lines.append("### Total Automated Score")
          lines.append(f"**{total_score}/70**")
          lines.append("")
          lines.append("*Remaining 30%: Code quality (20%) and plagiarism check (-10% max)*")
          lines.append("")

          output = "\n".join(lines)
          print(output)

          if summary_path:
              with open(summary_path, "a") as f:
                  f.write(output)
          PYEOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            visible_results.json
            hidden_results.json
            visible_output.txt
            hidden_output.txt
            output/
          retention-days: 30
